# UI比較投票アプリ 設計タスクチェックリスト（詳細）

このドキュメントは、`specs/idea.spec.md`、`specs/tech.spec.md`、`specs/product-spec.md` をもとに実装へ落とし込むための詳細タスクです。各セクションでアウトプットを定義し、チェックボックスを消化しながら進めてください。

## 1. 要件整理
- [ ] アイデア仕様と技術仕様の差分一覧を作成し、未定義の機能・制約を Issue 化（例: 投稿コンテンツの最大サイズ、言語対応）
- [ ] 投票フロー（閲覧→認証→投票→結果閲覧→共有）のシーケンス図とハッピーパス/エラーパスを整理（最大4案対応）
- [ ] 各ページ（トップ、比較詳細、投稿、ダッシュボード、認証）の情報設計と主要コンテンツリストをまとめる
- [ ] UI投稿者と閲覧者のペルソナ資料を作成し、目的・利用頻度・成功指標を定義
- [ ] MVPスコープ（初回リリースに含める機能/除外する機能）を確定し、公開ロードマップへ反映

## 2. アーキテクチャ決定
- [ ] Cloudflare Workers + Vite/React + StackBlitz WebContainers 構成図（データフロー・境界・依存サービス）を作成
- [ ] UIプレビュー iframe の通信仕様を策定（許可ドメイン、`postMessage` の利用有無、CSPポリシー）
- [ ] TursoDB 接続方式を文書化（libSQL クライアントの使用方法、接続再試行、レイテンシ許容値）
- [ ] 外部サービス（Firebase、StackBlitz、Turnstile 等）の利用権限と API 制限を整理
- [ ] バウンデッドコンテキスト（Comparison / Voting / User / Analytics）と責務境界を定義し、依存関係図を作成
- [ ] DDD レイヤ構成（domain / application / infrastructure / interfaces）とモジュール分割ポリシーを決定
- [ ] OpenAPI 仕様 (`specs/openapi.yaml`) の初期ドラフトを確定し、バージョニング/レビュー手順を定義
- [ ] Cloudflare Pages / Workers / Turso を Terraform でプロビジョニングする計画と `infra/terraform` モジュール構成をレビュー

## 3. データモデル
- [ ] エンティティ/リレーション図（ERD）を作成し、`users`, `ui_entries`, `ui_variants`, `votes`, `vote_sessions` などのカラム定義を含める（1案件最大4案）
- [ ] 投票集計のクエリ設計（期間別、デバイス別など）とキャッシュ方針を決定
- [ ] マイグレーション手順（`libsql` CLI または独自スクリプト）を整備し、ローカル/ステージング/本番の適用プロセスを定義
- [ ] データ整合性ルール（多重投票防止キー、削除ポリシー、アーカイブ戦略）を記述
- [ ] `vote_sessions` の冪等性キー戦略（`comparisonId:userId`）とユニーク制約運用、トランザクション制御 (`BEGIN IMMEDIATE`) を決定
- [ ] Turnstile トークンは保存せず、`vote_sessions.turnstile_verified` フラグのみ保持する方針を仕様・実装で統一

## 4. 認証・セキュリティ
- [ ] Firebase Authentication プロジェクトを作成し、使用するログインプロバイダとリダイレクトURLを設定
- [ ] フロントエンドでの `firebase/auth` 初期化・セッション維持処理（リフレッシュ、オフライン対応）を設計
- [ ] Workers での ID トークン検証フロー（キャッシュ層、タイムアウト、失効検知、エラーハンドリング）を定義
- [ ] StackBlitz iframe へ適用する `sandbox` 属性・`allow` 設定・CSPヘッダを決め、ボット対策（Turnstile/hCaptcha）の導入箇所を明文化
- [ ] 監査ログ方針（重要操作の記録、保存期間、閲覧権限）を決定

## 5. フロントエンド (Vite + React)
- [ ] Vite プロジェクト初期化（TypeScript, ESLint, Prettier, Vitest 設定）と Cloudflare Pages 互換ビルド設定
- [ ] 画面遷移図とコンポーネント構成（ページ毎のレイアウト、主要コンポーネント、状態管理方式）を定義
- [ ] UI投稿フォーム仕様（最大4件の StackBlitz プロジェクトURL検証、入力バリデーション、プレビューサムネイル取得）を策定
- [ ] 投票画面 UI（最大4案の選択、リアルタイムスコア表示、投票完了状態）をワイヤーフレームで確認
- [ ] OpenAPI から生成される型 (`pnpm generate:api`) の利用方針とクライアントコードの保守フローを策定
- [ ] Firebase 認証 UI（ログインモーダル、セッション状態、エラー表示）を実装計画に追加
- [ ] API クライアント層（`fetch` ラッパ、リトライ、トークン付与、エラー分類）を設計
- [ ] アクセシビリティ基準（キーボード操作、コントラスト、ARIA 属性）とレスポンシブ対応ガイドラインをまとめる

## 6. UIプレビュー連携 (StackBlitz WebContainers)
- [ ] UI投稿者が StackBlitz プロジェクトを作成・更新する手順を文書化し、必要なテンプレートを準備
- [ ] `embed.stackblitz.com` パラメータ仕様（`view=preview`, `hidedevtools=1`, `ctl=0` など）と将来拡張案を記載
- [ ] iframe ロード完了イベントの取り扱い（ロード中表示、タイムアウト、再試行）を設計
- [ ] 投票画面との同期方式（プレビュー表示中に投票ボタンを活性化する条件、エラー時の代替表示）を決める
- [ ] セキュリティ対策（`Content-Security-Policy`、`X-Frame-Options`、`postMessage` フィルタリング）を詳細化

## 7. バックエンド (Cloudflare Workers + Hono)
- [ ] REST API エンドポイント仕様書を作成（メソッド、パス、リクエスト/レスポンススキーマ、認可要件）
- [ ] DDD 観点でのユースケース一覧（コマンド/クエリ）とアプリケーションサービスの責務を定義
- [ ] ドメインエンティティ・値オブジェクト・ドメインイベントの一覧と不変条件を文書化
- [ ] Firebase トークン検証ミドルウェアとエラーハンドリングのシーケンスを定義
- [ ] TursoDB クライアントラッパ（接続初期化、クエリ実行、トランザクション）の設計
- [ ] リポジトリインターフェースとインフラ実装の対応表を作成（Comparison/Voting/Session）
- [ ] レートリミット／ボット対策の導入ポイント（投票API呼び出し頻度、IP/ユーザ単位の制限）を確定
- [ ] StackBlitz からの Webhook/同期が必要な場合のルートと署名検証方式を設計
- [ ] StackBlitz Webhook 用の HMAC 署名検証ユーティリティと再送/リプレイ対策（許容遅延 300 秒など）を実装
- [ ] 公開API（閲覧用）と保護API（投稿・投票用）のバージョニングとドメイン分離を検討
- [ ] OpenAPI 契約テスト（schemathesis など）の実施計画と CI 組み込み手順を整備
- [ ] Cloudflare Queues を用いたドメインイベント配送計画（`specs/domain-events.md`）をレビューし、Terraform モジュールとコンシューマ実装のタスクに落とし込む

## 8. インフラ・デリバリー
- [ ] Cloudflare Pages / Workers のビルド・デプロイパイプラインを `wrangler.toml` / GitHub Actions 等で構築
- [ ] 環境変数・Secrets 管理ルール（命名、登録場所、ローテーション手順）を整備
- [ ] ステージング / 本番のブランチ戦略とデプロイ承認フローを策定
- [ ] CDN キャッシュ戦略（静的アセットの TTL、投票APIのキャッシュ無効化、プレビューコンテンツのキャッシュ扱い）を定める
- [ ] 定期バックアップ（Turso スナップショット、StackBlitz プロジェクトバックアップ）の計画を作成
- [ ] Terraform state 管理ポリシー（Terraform Cloud / S3 + KMS 等）と環境別 `tfvars` の運用ルールを策定

## 9. オブザーバビリティ
- [ ] Sentry や Logflare の導入判断と初期設定（DSN、環境タグ、ログレベル）を実施
- [ ] Cloudflare Analytics と Turso メトリクスの監視ダッシュボードを作成し、主要KPIを定義
- [ ] 投票不正検知ロジック（異常スパイク検知、同一IP対策、通知方法）を設計
- [ ] アラートルール（閾値、通知チャンネル、エスカレーションフロー）を決定

## 10. テスト計画
- [ ] 単体テスト方針（コンポーネント、hooks、ユーティリティ）のカバレッジ目標と対象範囲を設定
- [ ] E2Eテスト（Playwright 等）でのシナリオ（ログイン、投稿、投票、結果確認）を定義し、テストデータ準備
- [ ] Workers API テストを Miniflare で実行する設定（モックデータ、Firebase/Tursoスタブ）を作成
- [ ] CI でのテスト実行フロー（lint → unit → e2e）と失敗時の対応手順を文書化
- [ ] StackBlitz 埋め込み確認用の手動チェックリストと自動スクリーンショット取得手順を整備

## 11. ドキュメンテーション
- [ ] 開発環境セットアップ手順書（依存ツール、環境変数、初期データ投入）を作成
- [ ] UI投稿者向けガイド（投稿から公開までの流れ、エラー対処、推奨ベストプラクティス）を準備
- [ ] 運用ハンドブック（定常運用、障害対応、ロールバック手順、オンコール体制）を整備
- [ ] リリースノートテンプレートと変更管理プロセス（タグ付け、バージョン付与、周知方法）を策定
- [ ] 設計ドキュメントの更新ルール（誰が・いつ・どこに記述するか）を決め、定期レビュー体制を設定
